<UserControl x:Class="Almoxarifado.Views.Cadastros.BolsaFixa"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Almoxarifado.Views.Cadastros" 
             xmlns:converter="clr-namespace:Almoxarifado.Converter"
             xmlns:telerik="http://schemas.telerik.com/2008/xaml/presentation"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800" Loaded="UserControl_Loaded" >

    <UserControl.Resources>
        <converter:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />

        <!-- Efeito de sombra para modal -->
        <DropShadowEffect x:Key="ModalShadowEffect"
                          Color="Black"
                          Direction="315"
                          ShadowDepth="10"
                          Opacity="0.4"
                          BlurRadius="15"/>

        <!-- Animações -->
        <Storyboard x:Key="ModalOpenAnimation">
            <DoubleAnimation Storyboard.TargetName="ModalContainer"
                             Storyboard.TargetProperty="Opacity"
                             From="0" To="1" Duration="0:0:0.25"/>
            <DoubleAnimation Storyboard.TargetName="ModalContainer"
                             Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                             From="0.9" To="1" Duration="0:0:0.25"/>
            <DoubleAnimation Storyboard.TargetName="ModalContainer"
                             Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                             From="0.9" To="1" Duration="0:0:0.25"/>
        </Storyboard>

        <Storyboard x:Key="ModalCloseAnimation">
            <DoubleAnimation Storyboard.TargetName="ModalContainer"
                             Storyboard.TargetProperty="Opacity"
                             From="1" To="0" Duration="0:0:0.2"/>
        </Storyboard>
    </UserControl.Resources>

    <Grid>
        <!-- Conteúdo principal -->
        <Grid x:Name="MainContent" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Orientation="Vertical" Grid.Row="1" Margin="0,5,0,0" HorizontalAlignment="Left">

                <StackPanel Orientation="Vertical" Width="250" HorizontalAlignment="Left">
                    <telerik:Label>TIPO DA BOLSA</telerik:Label>
                    <telerik:RadComboBox 
                        x:Name="bolsa" 
                        ItemsSource="{Binding Bolsas}" 
                        DisplayMemberPath="descricao"
                        SelectedValue="codigo_tipobolsa" 
                        SelectionChanged="origem_SelectionChanged"/>
                </StackPanel>

                <!-- Campo COD. PRODUTO com botão de busca -->
                <StackPanel Orientation="Vertical" Width="150" HorizontalAlignment="Left">
                    <telerik:Label>COD. PRODUTO</telerik:Label>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <telerik:RadAutoSuggestBox 
                            x:Name="txtCodProduto"
                            Grid.Column="0"
                            KeyDown="OnBuscaProduto"
                            QueryButtonVisibility="Collapsed"/>

                        <!-- Botão de busca personalizado -->
                        <Button x:Name="btnBuscarProduto"
                                Grid.Column="1"
                                Width="30" Height="28"
                                Content="🔍"
                                FontSize="12"
                                Margin="2,0,0,0"
                                Click="BtnBuscarProduto_Click"
                                ToolTip="Buscar produto"/>
                    </Grid>
                </StackPanel>

                <!-- Resto dos campos mantidos iguais -->
                <StackPanel Orientation="Vertical" Width="200" HorizontalAlignment="Left">
                    <telerik:Label>PLANILHA</telerik:Label>
                    <telerik:RadAutoSuggestBox
                        x:Name="autoCompletePlanilha" 
                        ItemsSource="{Binding Planilhas}" 
                        DisplayMemberPath="planilha" 
                        TextMemberPath="planilha" 
                        WatermarkContent="seleciona a planilha..." 
                        QueryButtonVisibility="Collapsed"
                        QuerySubmitted="OnQuerySubmitted"
                        GotFocus="RadAutoSuggestBox_GotFocus"/>
                </StackPanel>

                <StackPanel Orientation="Vertical" Width="300">
                    <telerik:Label>DESCRIÇÃO</telerik:Label>
                    <telerik:RadAutoSuggestBox
                        x:Name="autoCompleteDescricao" 
                        ItemsSource="{Binding Produtos}"
                        DisplayMemberPath="descricao" 
                        TextMemberPath="descricao" 
                        WatermarkContent="seleciona a descrição..."
                        QueryButtonVisibility="Collapsed"
                        QuerySubmitted="OnQuerySubmitted"
                        GotFocus="RadAutoSuggestBox_GotFocus"/>
                </StackPanel>

                <StackPanel Orientation="Vertical">
                    <telerik:Label>DESCRIÇÃO ADICIONAL</telerik:Label>
                    <telerik:RadAutoSuggestBox 
                        x:Name="autoCompleteDescricaoAdicional" 
                        ItemsSource="{Binding DescricaoAdicionais}"
                        DisplayMemberPath="descricao_adicional" 
                        TextMemberPath="descricao_adicional" 
                        WatermarkContent="seleciona a descrição adicional..."
                        QueryButtonVisibility="Collapsed"
                        QuerySubmitted="OnQuerySubmitted"
                        GotFocus="RadAutoSuggestBox_GotFocus"/>
                </StackPanel>

                <StackPanel Orientation="Vertical">
                    <telerik:Label>COMPLEMENTO ADICIONAL</telerik:Label>
                    <telerik:RadAutoSuggestBox
                        x:Name="autoCompleteComplementoAdicional" 
                        ItemsSource="{Binding ComplemntoAdicionais}"
                        DisplayMemberPath="complementoadicional" 
                        TextMemberPath="complementoadicional" 
                        WatermarkContent="seleciona o complemento adicional..."
                        QueryButtonVisibility="Collapsed"
                        QuerySubmitted="OnQuerySubmitted"
                        GotFocus="RadAutoSuggestBox_GotFocus"/>
                </StackPanel>

                <StackPanel Orientation="Vertical">
                    <StackPanel Orientation="Horizontal">
                        <StackPanel Orientation="Vertical" Width="100" Margin="0,0,5,0">
                            <telerik:Label>UNIDADE</telerik:Label>
                            <telerik:RadAutoSuggestBox 
                                x:Name="radMaskedUnidade"
                                Width="100" 
                                IsEnabled="False" 
                                HorizontalContentAlignment="Center" 
                                ClearButtonVisibility="Collapsed" 
                                QueryButtonVisibility="Collapsed"/>
                        </StackPanel>

                        <StackPanel Orientation="Vertical" Width="100" Margin="0,0,5,0">
                            <telerik:Label>QUANTIDADE</telerik:Label>
                            <telerik:RadAutoSuggestBox 
                                x:Name="txtQuantidade" 
                                HorizontalContentAlignment="Center" 
                                ClearButtonVisibility="Collapsed" 
                                QueryButtonVisibility="Collapsed"/>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Height="33" Margin="0,5,0,5" >

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="5"/>
                            <ColumnDefinition Width="100"/>
                        </Grid.ColumnDefinitions>

                        <telerik:RadButton x:Name="btnGravar" Grid.Column="0" Content="GRAVAR" Click="OnSaveClick"/>
                        <telerik:RadButton x:Name="btnAlterar" Grid.Column="2" Content="Alterar" Click="OnAlterarClick"/>
                        
                    </Grid>
                </StackPanel>

            </StackPanel>

            <!-- Grid de Itens -->
            <telerik:RadGridView x:Name="produtos" Grid.Row="2" 
                                 ItemsSource="{Binding BolsaFixas}"
                                 AutoGenerateColumns="False"
                                 CanUserInsertRows="False"
                                 ShowGroupPanel="False"
                                 MouseDoubleClick="RadGridView_MouseDoubleClick" 
                                 PreviewKeyDown="RadGridView_PreviewKeyDown" CellEditEnded="RadGridView_CellEditEnded">
                <telerik:RadGridView.Columns>
                    <telerik:GridViewDataColumn IsReadOnly="True" Header="#" DataMemberBinding="{Binding codcompladicional}"/>
                    <telerik:GridViewDataColumn IsReadOnly="True" Header="Planilha" DataMemberBinding="{Binding planilha}" Width="150"/>
                    <telerik:GridViewDataColumn IsReadOnly="True" Header="Descrição" DataMemberBinding="{Binding descricao_completa}" Width="*"/>
                    <telerik:GridViewDataColumn IsReadOnly="True" Header="Unidade" DataMemberBinding="{Binding unidade}" Width="80"/>
                    <telerik:GridViewDataColumn IsReadOnly="True" Header="Qtde" DataMemberBinding="{Binding quantidade}" DataFormatString="{}{0:N2}" Width="60"/>
                    <telerik:GridViewDataColumn IsReadOnly="False" Header="VL. Unit." DataMemberBinding="{Binding valor_unitario}" DataFormatString="{}{0:C2}" Width="80"/>
                    <telerik:GridViewDataColumn IsReadOnly="True" Header="VL. Total" DataMemberBinding="{Binding valor_total}" DataFormatString="{}{0:C2}" Width="80"/>
                    <!--<telerik:GridViewDataColumn Header="Observação" DataMemberBinding="{Binding Observacao}" Width="200"/>-->
                </telerik:RadGridView.Columns>
            </telerik:RadGridView>

            <!-- Overlay de carregamento original -->
            <Grid Background="#80000000" 
                  Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock Text="Carregando..." Foreground="White" FontSize="20"
                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Grid>
        </Grid>

        <!-- Modal Overlay -->
        <Grid x:Name="ModalOverlay" 
              Background="#80000000" 
              Visibility="Collapsed"
              Panel.ZIndex="2000"
              MouseDown="ModalOverlay_MouseDown">

            <!-- Container do modal posicionado -->
            <Canvas x:Name="ModalCanvas">
                <Border x:Name="ModalContainer"
                        Background="White"
                        BorderBrush="#DDDDDD"
                        BorderThickness="1"
                        CornerRadius="8"
                        Effect="{StaticResource ModalShadowEffect}"
                        Visibility="Collapsed"
                        RenderTransformOrigin="0.5,0.5">

                    <Border.RenderTransform>
                        <ScaleTransform ScaleX="1" ScaleY="1"/>
                    </Border.RenderTransform>

                    <!-- Conteúdo da modal -->
                    <ContentPresenter x:Name="ModalContent" />
                </Border>
            </Canvas>
        </Grid>
    </Grid>
</UserControl>
